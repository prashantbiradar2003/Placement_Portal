<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - College Placement Portal</title>
  <link rel="stylesheet" href="styles/bootstrap.min.css">
  <link rel="stylesheet" href="styles/style.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="dashboard.html">College Placement Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="applications.html">Applications</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="jobs.html">Browse Jobs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="profile.html">Profile</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#" id="logout-btn">Logout</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-md-4 mb-4">
        <div class="card">
          <div class="card-body text-center">
            <div class="mb-3">
              <img src="images/default-avatar.png" alt="Profile" class="rounded-circle" width="150" height="150" id="profile-image" onerror="this.src='https://via.placeholder.com/150'">
            </div>
            <h4 id="user-name">Loading...</h4>
            <p class="text-muted" id="user-role">Loading...</p>
            <p class="text-muted" id="user-email">Loading...</p>
            <button class="btn btn-outline-primary mt-2" id="edit-profile-btn">Edit Profile</button>
          </div>
        </div>
        
        <div class="card mt-3">
          <div class="card-header">
            <h5 class="mb-0">Account Security</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <button class="btn btn-outline-secondary w-100" id="change-password-btn">Change Password</button>
            </div>
            <div class="mb-3">
              <button class="btn btn-outline-danger w-100" id="delete-account-btn">Delete Account</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">Profile Information</h5>
          </div>
          <div class="card-body">
            <form id="profile-form" style="display: none;">
              <div class="mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" required>
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              <div class="mb-3" id="student-fields" style="display: none;">
                <label for="roll-number" class="form-label">Roll Number</label>
                <input type="text" class="form-control" id="roll-number">
              </div>
              <div class="mb-3" id="student-fields-2" style="display: none;">
                <label for="department" class="form-label">Department</label>
                <select class="form-control" id="department">
                  <option value="">Select your branch</option>
                  <option value="Computer Science Engineering">Computer Science Engineering</option>
                  <option value="Information Science">Information Science</option>
                  <option value="Electronics and Communication">Electronics and Communication</option>
                  <option value="AIML">AIML</option>
                  <option value="Electrical and Electronics">Electrical and Electronics</option>
                  <option value="Civil">Civil</option>
                  <option value="Mechanical">Mechanical</option>
                  <option value="Chemical">Chemical</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" class="form-control" id="phone">
              </div>
              <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" id="cancel-edit-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>

            <div id="profile-details">
              <div class="row mb-3">
                <div class="col-sm-3">
                  <h6 class="mb-0">Full Name</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-name">
                  Loading...
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-3">
                  <h6 class="mb-0">Email</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-email">
                  Loading...
                </div>
              </div>
              <div class="row mb-3" id="detail-student-row-1" style="display: none;">
                <div class="col-sm-3">
                  <h6 class="mb-0">Roll Number</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-roll">
                  --
                </div>
              </div>
              <div class="row mb-3" id="detail-student-row-2" style="display: none;">
                <div class="col-sm-3">
                  <h6 class="mb-0">Department</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-department">
                  --
                </div>
              </div>
              <div class="row mb-3" id="detail-company-row" style="display: none;">
                <div class="col-sm-3">
                  <h6 class="mb-0">Company</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-company">
                  --
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-3">
                  <h6 class="mb-0">Phone</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-phone">
                  --
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-3">
                  <h6 class="mb-0">Account Type</h6>
                </div>
                <div class="col-sm-9 text-secondary" id="detail-role">
                  Loading...
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-3" id="student-resume-section" style="display: none;">
          <div class="card-header">
            <h5 class="mb-0">Resume</h5>
          </div>
          <div class="card-body">
            <div id="resume-display">
              <p id="no-resume-message" style="display: none;">No resume uploaded yet.</p>
              <div id="resume-info" style="display: none;">
                <div class="d-flex align-items-center mb-3">
                  <i class="bi bi-file-earmark-pdf me-2 fs-4"></i>
                  <div>
                    <p class="mb-0" id="resume-filename">resume.pdf</p>
                    <small class="text-muted" id="resume-upload-date">Uploaded on: Jan 1, 2023</small>
                  </div>
                  <div class="ms-auto">
                    <a href="#" class="btn btn-sm btn-primary me-2" id="view-resume-btn">View</a>
                    <button class="btn btn-sm btn-outline-danger" id="delete-resume-btn">Delete</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <form id="resume-upload-form">
                <div class="mb-3">
                  <label for="resume-file" class="form-label">Upload Resume (PDF)</label>
                  <input class="form-control" type="file" id="resume-file" accept=".pdf">
                </div>
                <button type="submit" class="btn btn-primary">Upload Resume</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal fade" id="change-password-modal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="change-password-form">
            <div class="mb-3">
              <label for="current-password" class="form-label">Current Password</label>
              <input type="password" class="form-control" id="current-password" required>
            </div>
            <div class="mb-3">
              <label for="new-password" class="form-label">New Password</label>
              <input type="password" class="form-control" id="new-password" required>
            </div>
            <div class="mb-3">
              <label for="confirm-password" class="form-label">Confirm New Password</label>
              <input type="password" class="form-control" id="confirm-password" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-password-btn">Change Password</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div class="modal fade" id="delete-account-modal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteAccountModalLabel">Delete Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete your account? This action cannot be undone.</p>
          <div class="mb-3">
            <label for="delete-confirm-password" class="form-label">Enter your password to confirm</label>
            <input type="password" class="form-control" id="delete-confirm-password" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Account</button>
        </div>
      </div>
    </div>
  </div>

  <script src="scripts/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      // Fetch user profile data
      fetchUserProfile();

      // Event listeners
      document.getElementById('logout-btn').addEventListener('click', logout);
      document.getElementById('edit-profile-btn').addEventListener('click', toggleEditMode);
      document.getElementById('cancel-edit-btn').addEventListener('click', toggleEditMode);
      document.getElementById('profile-form').addEventListener('submit', updateProfile);
      document.getElementById('change-password-btn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('change-password-modal'));
        modal.show();
      });
      document.getElementById('delete-account-btn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('delete-account-modal'));
        modal.show();
      });
      document.getElementById('save-password-btn').addEventListener('click', changePassword);
      document.getElementById('confirm-delete-btn').addEventListener('click', deleteAccount);
      
      // Resume actions for students
      document.getElementById('resume-upload-form').addEventListener('submit', uploadResume);
      document.getElementById('delete-resume-btn')?.addEventListener('click', deleteResume);
    });

    function fetchUserProfile() {
      const token = localStorage.getItem('token');
      
      fetch('/api/users/profile', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to fetch profile');
        }
        return response.json();
      })
      .then(data => {
        // Update UI with user data
        document.getElementById('user-name').textContent = data.name;
        document.getElementById('user-email').textContent = data.email;
        document.getElementById('user-role').textContent = formatRole(data.role);
        
        // Form fields
        document.getElementById('name').value = data.name;
        document.getElementById('email').value = data.email;
        document.getElementById('phone').value = data.phone || '';
        
        // Profile details
        document.getElementById('detail-name').textContent = data.name;
        document.getElementById('detail-email').textContent = data.email;
        document.getElementById('detail-phone').textContent = data.phone || '--';
        document.getElementById('detail-role').textContent = formatRole(data.role);
        
        // Handle role-specific fields
        if (data.role === 'student') {
          document.getElementById('student-fields').style.display = 'block';
          document.getElementById('student-fields-2').style.display = 'block';
          document.getElementById('detail-student-row-1').style.display = 'flex';
          document.getElementById('detail-student-row-2').style.display = 'flex';
          document.getElementById('student-resume-section').style.display = 'block';
          
          if (data.rollNumber) {
            document.getElementById('roll-number').value = data.rollNumber;
            document.getElementById('detail-roll').textContent = data.rollNumber;
          }
          
          if (data.department) {
            document.getElementById('department').value = data.department;
            document.getElementById('detail-department').textContent = data.department;
          }
          
          // Check if resume exists
          if (data.resume) {
            document.getElementById('no-resume-message').style.display = 'none';
            document.getElementById('resume-info').style.display = 'block';
            document.getElementById('resume-filename').textContent = data.resume.filename || 'resume.pdf';
            document.getElementById('resume-upload-date').textContent = 'Uploaded on: ' + 
              (data.resume.uploadDate ? new Date(data.resume.uploadDate).toLocaleDateString() : 'Unknown date');
            document.getElementById('view-resume-btn').href = `/api/upload/resume/${data.id}`;
          } else {
            document.getElementById('no-resume-message').style.display = 'block';
            document.getElementById('resume-info').style.display = 'none';
          }
        } else if (data.role === 'recruiter' && data.company) {
          document.getElementById('detail-company-row').style.display = 'flex';
          document.getElementById('detail-company').textContent = data.company;
        }
      })
      .catch(error => {
        console.error('Error fetching profile:', error);
        alert('Failed to load profile data. Please try again later.');
      });
    }

    function toggleEditMode() {
      const detailsDiv = document.getElementById('profile-details');
      const formDiv = document.getElementById('profile-form');
      
      if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        formDiv.style.display = 'none';
      } else {
        detailsDiv.style.display = 'none';
        formDiv.style.display = 'block';
      }
    }

    function updateProfile(event) {
      event.preventDefault();
      
      const token = localStorage.getItem('token');
      const userData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value
      };
      
      // Add role-specific fields
      const rollNumberEl = document.getElementById('roll-number');
      if (rollNumberEl && rollNumberEl.parentElement.style.display !== 'none') {
        userData.rollNumber = rollNumberEl.value;
      }
      
      const departmentEl = document.getElementById('department');
      if (departmentEl && departmentEl.parentElement.style.display !== 'none') {
        userData.department = departmentEl.value;
      }
      
      fetch('/api/users/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(userData)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to update profile');
        }
        return response.json();
      })
      .then(data => {
        alert('Profile updated successfully');
        toggleEditMode();
        fetchUserProfile(); // Refresh the profile data
      })
      .catch(error => {
        console.error('Error updating profile:', error);
        alert('Failed to update profile. Please try again.');
      });
    }

    function changePassword() {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      if (newPassword !== confirmPassword) {
        alert('New password and confirmation do not match');
        return;
      }
      
      const token = localStorage.getItem('token');
      
      fetch('/api/users/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          currentPassword,
          newPassword
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to change password');
        }
        return response.json();
      })
      .then(data => {
        alert('Password changed successfully');
        document.getElementById('change-password-form').reset();
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('change-password-modal'));
        modal.hide();
      })
      .catch(error => {
        console.error('Error changing password:', error);
        alert('Failed to change password. Please check your current password and try again.');
      });
    }

    function deleteAccount() {
      const password = document.getElementById('delete-confirm-password').value;
      const token = localStorage.getItem('token');
      
      fetch('/api/users/delete-account', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ password })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to delete account');
        }
        return response.json();
      })
      .then(data => {
        alert('Account deleted successfully');
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      })
      .catch(error => {
        console.error('Error deleting account:', error);
        alert('Failed to delete account. Please check your password and try again.');
      });
    }

    function uploadResume(event) {
      event.preventDefault();
      
      const fileInput = document.getElementById('resume-file');
      if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
      }
      
      if (fileInput.files[0].type !== 'application/pdf') {
        alert('Please upload a PDF file');
        return;
      }
      
      const formData = new FormData();
      formData.append('resume', fileInput.files[0]);
      
      const token = localStorage.getItem('token');
      
      fetch('/api/users/resume', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to upload resume');
        }
        return response.json();
      })
      .then(data => {
        alert('Resume uploaded successfully');
        fetchUserProfile(); // Refresh the profile data
        fileInput.value = ''; // Clear the file input
      })
      .catch(error => {
        console.error('Error uploading resume:', error);
        alert('Failed to upload resume. Please try again.');
      });
    }

    function deleteResume(event) {
      event.preventDefault();
      
      if (!confirm('Are you sure you want to delete your resume?')) {
        return;
      }
      
      const token = localStorage.getItem('token');
      
      fetch('/api/users/resume', {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Failed to delete resume');
        }
        return response.json();
      })
      .then(data => {
        alert('Resume deleted successfully');
        fetchUserProfile(); // Refresh the profile data
      })
      .catch(error => {
        console.error('Error deleting resume:', error);
        alert('Failed to delete resume. Please try again.');
      });
    }

    function formatRole(role) {
      if (!role) return 'User';
      return role.charAt(0).toUpperCase() + role.slice(1);
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
  </script>
</body>
</html> 